<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Alfred Dashboard</title>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
      color: #e8e8e8;
      min-height: 100vh;
      padding: 24px;
    }
    .header {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 32px;
      max-width: 960px;
      margin-left: auto;
      margin-right: auto;
    }
    .header h1 { font-size: 28px; font-weight: 600; }
    .header .emoji { font-size: 32px; }
    .grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 20px;
      max-width: 960px;
      margin: 0 auto;
    }
    .card {
      background: rgba(255,255,255,0.05);
      border: 1px solid rgba(255,255,255,0.1);
      border-radius: 16px;
      padding: 20px;
      backdrop-filter: blur(10px);
    }
    .card.wide { grid-column: span 2; }
    .card.full { grid-column: span 3; }
    .card h2 {
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 1.5px;
      color: #666;
      margin-bottom: 12px;
    }
    .stat {
      font-size: 36px;
      font-weight: 700;
      color: #4ade80;
    }
    .stat.warning { color: #fbbf24; }
    .stat.danger { color: #f87171; }
    .stat-label {
      font-size: 13px;
      color: #888;
      margin-top: 2px;
    }
    .progress-bar {
      height: 6px;
      background: rgba(255,255,255,0.1);
      border-radius: 3px;
      margin-top: 12px;
      overflow: hidden;
    }
    .progress-fill {
      height: 100%;
      background: linear-gradient(90deg, #4ade80, #22d3ee);
      border-radius: 3px;
      transition: width 0.3s ease;
    }
    .progress-fill.warning { background: linear-gradient(90deg, #fbbf24, #f59e0b); }
    .progress-fill.danger { background: linear-gradient(90deg, #f87171, #ef4444); }
    .detail-row {
      display: flex;
      justify-content: space-between;
      padding: 6px 0;
      font-size: 13px;
      border-bottom: 1px solid rgba(255,255,255,0.05);
    }
    .detail-row:last-child { border-bottom: none; }
    .detail-label { color: #666; }
    .detail-value { font-weight: 500; color: #aaa; }
    .timestamp {
      text-align: center;
      color: #555;
      font-size: 11px;
      margin-top: 24px;
      max-width: 960px;
      margin-left: auto;
      margin-right: auto;
    }

    /* Model Usage */
    .model-list { display: flex; flex-direction: column; gap: 14px; }
    .model-item {
      display: flex;
      align-items: center;
      gap: 12px;
    }
    .model-badge {
      padding: 5px 10px;
      border-radius: 6px;
      font-size: 12px;
      font-weight: 600;
      min-width: 70px;
      text-align: center;
    }
    .model-badge.opus { background: linear-gradient(135deg, #8b5cf6, #6d28d9); }
    .model-badge.sonnet { background: linear-gradient(135deg, #3b82f6, #1d4ed8); }
    .model-badge.haiku { background: linear-gradient(135deg, #10b981, #059669); }
    .model-badge.local { background: linear-gradient(135deg, #f59e0b, #d97706); }
    .model-data {
      flex: 1;
      display: flex;
      flex-direction: column;
      gap: 4px;
    }
    .model-stats-row {
      display: flex;
      gap: 16px;
      font-size: 12px;
      color: #888;
    }
    .model-stats-row .value { color: #ccc; font-weight: 500; }
    .model-bar-wrap {
      height: 4px;
      background: rgba(255,255,255,0.1);
      border-radius: 2px;
      overflow: hidden;
    }
    .model-bar {
      height: 100%;
      border-radius: 2px;
      transition: width 0.3s ease;
    }
    .model-bar.opus { background: #8b5cf6; }
    .model-bar.sonnet { background: #3b82f6; }
    .model-bar.haiku { background: #10b981; }
    .model-bar.local { background: #f59e0b; }

    /* Tab toggle */
    .tab-bar {
      display: flex;
      gap: 4px;
      margin-bottom: 16px;
      background: rgba(255,255,255,0.05);
      border-radius: 8px;
      padding: 3px;
      width: fit-content;
    }
    .tab-btn {
      padding: 5px 14px;
      border: none;
      border-radius: 6px;
      background: transparent;
      color: #888;
      font-size: 12px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s;
    }
    .tab-btn:hover { color: #ccc; }
    .tab-btn.active {
      background: rgba(255,255,255,0.1);
      color: #e8e8e8;
    }

    /* Credit controls */
    .credit-controls {
      margin-top: 14px;
      padding-top: 12px;
      border-top: 1px solid rgba(255,255,255,0.08);
    }
    .credit-row {
      display: flex;
      gap: 6px;
      margin-bottom: 6px;
    }
    .credit-input {
      flex: 1;
      padding: 6px 10px;
      border: 1px solid rgba(255,255,255,0.15);
      border-radius: 6px;
      background: rgba(255,255,255,0.05);
      color: #e8e8e8;
      font-size: 13px;
      outline: none;
      min-width: 0;
    }
    .credit-input:focus {
      border-color: rgba(74, 222, 128, 0.4);
    }
    .credit-input::placeholder { color: #555; }
    .credit-btn {
      padding: 6px 12px;
      border: none;
      border-radius: 6px;
      font-size: 12px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
      white-space: nowrap;
    }
    .credit-btn.add {
      background: linear-gradient(135deg, #4ade80, #22c55e);
      color: #0a2010;
    }
    .credit-btn.set {
      background: rgba(255,255,255,0.1);
      color: #aaa;
    }
    .credit-btn:hover { opacity: 0.85; transform: translateY(-1px); }
    .credit-btn:active { transform: translateY(0); }
    .credit-feedback {
      font-size: 11px;
      color: #4ade80;
      min-height: 16px;
      margin-top: 4px;
      transition: opacity 0.3s;
    }

    /* Toast */
    .toast {
      position: fixed;
      bottom: 24px;
      left: 50%;
      transform: translateX(-50%) translateY(80px);
      background: rgba(30, 30, 50, 0.95);
      border: 1px solid rgba(74, 222, 128, 0.3);
      border-radius: 10px;
      padding: 10px 20px;
      font-size: 13px;
      color: #4ade80;
      backdrop-filter: blur(10px);
      transition: transform 0.3s ease;
      z-index: 100;
      pointer-events: none;
    }
    .toast.show { transform: translateX(-50%) translateY(0); }

    /* Cron Jobs */
    .cron-item {
      background: rgba(255,255,255,0.03);
      border: 1px solid rgba(255,255,255,0.08);
      border-radius: 10px;
      padding: 14px;
      margin-bottom: 12px;
    }
    .cron-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
    }
    .cron-name {
      font-size: 14px;
      font-weight: 600;
      color: #e8e8e8;
    }
    .cron-enabled {
      padding: 3px 8px;
      border-radius: 4px;
      font-size: 10px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    .cron-enabled.on {
      background: rgba(74, 222, 128, 0.2);
      color: #4ade80;
    }
    .cron-enabled.off {
      background: rgba(156, 163, 175, 0.2);
      color: #9ca3af;
    }
    .cron-details {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 10px;
      font-size: 12px;
    }
    .cron-detail {
      display: flex;
      flex-direction: column;
      gap: 3px;
    }
    .cron-detail-label {
      color: #666;
      font-size: 10px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    .cron-detail-value {
      color: #ccc;
      font-weight: 500;
    }
    .cron-model-badge {
      display: inline-block;
      padding: 2px 6px;
      border-radius: 4px;
      font-size: 10px;
      font-weight: 600;
    }
    .cron-model-badge.local { background: rgba(245, 158, 11, 0.2); color: #f59e0b; }
    .cron-model-badge.sonnet { background: rgba(59, 130, 246, 0.2); color: #3b82f6; }
    .cron-model-badge.haiku { background: rgba(16, 185, 129, 0.2); color: #10b981; }
    .cron-model-badge.opus { background: rgba(139, 92, 246, 0.2); color: #8b5cf6; }
    .cron-schedule {
      color: #888;
      font-size: 11px;
      margin-top: 8px;
      padding-top: 8px;
      border-top: 1px solid rgba(255,255,255,0.05);
    }

    @media (max-width: 800px) {
      .grid { grid-template-columns: 1fr; }
      .card.wide, .card.full { grid-column: span 1; }
      .cron-details { grid-template-columns: 1fr; }
    }
  </style>
</head>
<body>
  <div class="header">
    <span class="emoji">ðŸŽ©</span>
    <h1>Alfred Dashboard</h1>
  </div>

  <div class="grid">
    <!-- Credits -->
    <div class="card">
      <h2>Credits</h2>
      <div class="stat" id="credits-remaining">â€”</div>
      <div class="stat-label">remaining</div>
      <div class="progress-bar">
        <div class="progress-fill" id="credits-bar" style="width: 100%"></div>
      </div>
      <div style="margin-top: 12px;">
        <div class="detail-row">
          <span class="detail-label">Spent</span>
          <span class="detail-value" id="credits-spent">$0.00</span>
        </div>
        <div class="detail-row">
          <span class="detail-label">Total Credits</span>
          <span class="detail-value" id="credits-total">$0.00</span>
        </div>
        <div class="detail-row">
          <span class="detail-label">Avg / Week</span>
          <span class="detail-value" id="credits-weekly-avg">$0.00</span>
        </div>
      </div>
      <div class="credit-controls">
        <div class="credit-row">
          <input type="number" step="0.01" min="0" class="credit-input" id="credit-amount" placeholder="Amount ($)">
          <button class="credit-btn add" onclick="addCredits()">+ Add</button>
          <button class="credit-btn set" onclick="setCredits()">Set</button>
        </div>
        <div class="credit-feedback" id="credit-feedback"></div>
      </div>
    </div>

    <!-- Context Window -->
    <div class="card">
      <h2>Context</h2>
      <div class="stat" id="context-pct">â€”</div>
      <div class="stat-label" id="context-detail">â€” / â€” tokens</div>
      <div class="progress-bar">
        <div class="progress-fill" id="context-bar" style="width: 0%"></div>
      </div>
    </div>

    <!-- Current Session -->
    <div class="card">
      <h2>This Session</h2>
      <div class="stat" id="session-cost">$0.00</div>
      <div class="stat-label" id="session-tokens">0 tokens</div>
      <div style="margin-top: 12px;">
        <div class="detail-row">
          <span class="detail-label">Model</span>
          <span class="detail-value" id="model-name">â€”</span>
        </div>
      </div>
    </div>

    <!-- Today -->
    <div class="card">
      <h2>Today</h2>
      <div class="stat" id="today-cost">$0.00</div>
      <div class="stat-label" id="today-tokens">0 tokens</div>
      <div style="margin-top: 12px;">
        <div class="detail-row">
          <span class="detail-label">Sessions</span>
          <span class="detail-value" id="today-sessions">0</span>
        </div>
      </div>
    </div>

    <!-- Daily Average -->
    <div class="card">
      <h2>Daily Average</h2>
      <div class="stat" id="avg-cost">$0.00</div>
      <div class="stat-label" id="avg-tokens">0 tokens</div>
      <div style="margin-top: 12px;">
        <div class="detail-row">
          <span class="detail-label">Sessions</span>
          <span class="detail-value" id="avg-sessions">0</span>
        </div>
      </div>
    </div>

    <!-- Token Breakdown -->
    <div class="card wide">
      <h2>Token Breakdown (All Time)</h2>
      <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
        <div>
          <div style="font-size: 11px; color: #666; text-transform: uppercase; margin-bottom: 8px;">API Tokens</div>
          <div class="detail-row">
            <span class="detail-label">Input</span>
            <span class="detail-value" id="total-input">0</span>
          </div>
          <div class="detail-row">
            <span class="detail-label">Output</span>
            <span class="detail-value" id="total-output">0</span>
          </div>
        </div>
        <div>
          <div style="font-size: 11px; color: #666; text-transform: uppercase; margin-bottom: 8px;">Cache Tokens</div>
          <div class="detail-row">
            <span class="detail-label">Cache Read</span>
            <span class="detail-value" id="total-cache-read">0</span>
          </div>
          <div class="detail-row">
            <span class="detail-label">Cache Write</span>
            <span class="detail-value" id="total-cache-write">0</span>
          </div>
        </div>
      </div>
      <div style="margin-top: 12px; padding-top: 12px; border-top: 1px solid rgba(255,255,255,0.1);">
        <div style="font-size: 11px; color: #666; text-transform: uppercase; margin-bottom: 8px;">Cost Breakdown</div>
        <div class="detail-row">
          <span class="detail-label">Input + Output</span>
          <span class="detail-value" id="cost-io">$0.00</span>
        </div>
        <div class="detail-row">
          <span class="detail-label">Cache (Read + Write)</span>
          <span class="detail-value" id="cost-cache">$0.00</span>
        </div>
      </div>
    </div>

    <!-- Model Usage -->
    <div class="card full">
      <h2>Model Usage</h2>
      <div class="tab-bar" id="model-tabs">
        <button class="tab-btn active" data-period="total" onclick="setModelPeriod('total')">Total</button>
        <button class="tab-btn" data-period="thisWeek" onclick="setModelPeriod('thisWeek')">This Week</button>
        <button class="tab-btn" data-period="today" onclick="setModelPeriod('today')">Today</button>
      </div>
      <div class="model-list">
        <div class="model-item">
          <span class="model-badge opus">Opus</span>
          <div class="model-data">
            <div class="model-stats-row">
              <span><span class="value" id="opus-tokens">0</span> tokens</span>
              <span><span class="value" id="opus-cost">$0.00</span></span>
              <span><span class="value" id="opus-sessions">0</span> sessions</span>
            </div>
            <div class="model-bar-wrap">
              <div class="model-bar opus" id="opus-bar" style="width: 0%"></div>
            </div>
          </div>
        </div>
        <div class="model-item">
          <span class="model-badge sonnet">Sonnet</span>
          <div class="model-data">
            <div class="model-stats-row">
              <span><span class="value" id="sonnet-tokens">0</span> tokens</span>
              <span><span class="value" id="sonnet-cost">$0.00</span></span>
              <span><span class="value" id="sonnet-sessions">0</span> sessions</span>
            </div>
            <div class="model-bar-wrap">
              <div class="model-bar sonnet" id="sonnet-bar" style="width: 0%"></div>
            </div>
          </div>
        </div>
        <div class="model-item">
          <span class="model-badge haiku">Haiku</span>
          <div class="model-data">
            <div class="model-stats-row">
              <span><span class="value" id="haiku-tokens">0</span> tokens</span>
              <span><span class="value" id="haiku-cost">$0.00</span></span>
              <span><span class="value" id="haiku-sessions">0</span> sessions</span>
            </div>
            <div class="model-bar-wrap">
              <div class="model-bar haiku" id="haiku-bar" style="width: 0%"></div>
            </div>
          </div>
        </div>
        <div class="model-item">
          <span class="model-badge local">Local</span>
          <div class="model-data">
            <div class="model-stats-row">
              <span><span class="value" id="local-tokens">0</span> tokens</span>
              <span><span class="value" id="local-cost">FREE</span></span>
              <span><span class="value" id="local-sessions">0</span> sessions</span>
            </div>
            <div class="model-bar-wrap">
              <div class="model-bar local" id="local-bar" style="width: 0%"></div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Regular Runs / Cron Jobs -->
    <div class="card full">
      <h2>Regular Runs (Cron Jobs)</h2>
      <div style="font-size: 12px; color: #666; margin-bottom: 16px;">
        Scheduled tasks with estimated token usage and cost
      </div>
      <div id="cron-list">
        <!-- Populated by JS -->
      </div>
    </div>
  </div>

  <div class="timestamp" id="updated">Last updated: â€”</div>
  <div class="toast" id="toast"></div>

  <script>
    let dashData = null;
    let currentPeriod = 'total';

    // â”€â”€ Toast â”€â”€
    function showToast(msg) {
      const t = document.getElementById('toast');
      t.textContent = msg;
      t.classList.add('show');
      setTimeout(() => t.classList.remove('show'), 2500);
    }

    // â”€â”€ Credit API â”€â”€
    async function addCredits() {
      const input = document.getElementById('credit-amount');
      const amount = parseFloat(input.value);
      if (isNaN(amount) || amount <= 0) return showToast('Enter a positive amount');
      try {
        const resp = await fetch('/api/credits/add', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ amount, note: `Added $${amount.toFixed(2)}` }),
        });
        const data = await resp.json();
        if (data.error) return showToast('Error: ' + data.error);
        input.value = '';
        showToast(`+$${amount.toFixed(2)} credits added`);
        // Update budget in dashData and re-render credits
        if (dashData) {
          dashData.budget.totalCredits = data.totalCredits;
          renderCredits(dashData);
        }
      } catch (e) { showToast('Failed to add credits'); }
    }

    async function setCredits() {
      const input = document.getElementById('credit-amount');
      const amount = parseFloat(input.value);
      if (isNaN(amount) || amount < 0) return showToast('Enter a valid amount');
      try {
        const resp = await fetch('/api/credits/set', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ amount, note: `Balance set to $${amount.toFixed(2)}` }),
        });
        const data = await resp.json();
        if (data.error) return showToast('Error: ' + data.error);
        input.value = '';
        showToast(`Balance set to $${amount.toFixed(2)}`);
        if (dashData) {
          dashData.budget.totalCredits = data.totalCredits;
          renderCredits(dashData);
        }
      } catch (e) { showToast('Failed to set credits'); }
    }

    // â”€â”€ Render: Credits â”€â”€
    function renderCredits(d) {
      if (!d.budget) return;
      const total = d.budget.totalCredits || 0;
      const spent = d.budget.spent || 0;
      const remaining = total - spent;
      const pct = total > 0 ? (remaining / total) * 100 : 0;

      document.getElementById('credits-remaining').textContent = '$' + remaining.toFixed(2);
      document.getElementById('credits-spent').textContent = '$' + spent.toFixed(4);
      document.getElementById('credits-total').textContent = '$' + total.toFixed(2);
      document.getElementById('credits-bar').style.width = Math.max(0, pct) + '%';

      // Weekly average
      const weeklyAvg = d.weeklyAverage ? d.weeklyAverage.cost : 0;
      document.getElementById('credits-weekly-avg').textContent = '$' + weeklyAvg.toFixed(2);

      // Color coding
      const bar = document.getElementById('credits-bar');
      const stat = document.getElementById('credits-remaining');
      if (remaining <= 0) {
        bar.className = 'progress-fill danger';
        stat.className = 'stat danger';
      } else if (pct < 10) {
        bar.className = 'progress-fill danger';
        stat.className = 'stat danger';
      } else if (pct < 25) {
        bar.className = 'progress-fill warning';
        stat.className = 'stat warning';
      } else {
        bar.className = 'progress-fill';
        stat.className = 'stat';
      }
    }

    // â”€â”€ Render: Model Usage â”€â”€
    function setModelPeriod(period) {
      currentPeriod = period;
      document.querySelectorAll('#model-tabs .tab-btn').forEach(b => {
        b.classList.toggle('active', b.dataset.period === period);
      });
      if (dashData) renderModels(dashData);
    }

    function renderModels(d) {
      if (!d.models) return;
      const keys = ['opus', 'sonnet', 'haiku', 'local'];
      let maxCost = 0.01;
      let maxTokens = 1;

      keys.forEach(m => {
        const md = d.models[m]?.[currentPeriod] || d.models[m] || {};
        const cost = md.cost || 0;
        const tokens = (md.tokensIn || 0) + (md.tokensOut || 0);
        if (cost > maxCost) maxCost = cost;
        if (tokens > maxTokens) maxTokens = tokens;
      });

      keys.forEach(m => {
        const md = d.models[m]?.[currentPeriod] || d.models[m] || {};
        const tokensIn = md.tokensIn || 0;
        const tokensOut = md.tokensOut || 0;
        const totalTokens = tokensIn + tokensOut;
        const cost = md.cost || 0;
        const sessions = md.sessions || 0;

        document.getElementById(`${m}-tokens`).textContent = totalTokens.toLocaleString();
        document.getElementById(`${m}-sessions`).textContent = sessions;

        if (m === 'local') {
          document.getElementById(`${m}-bar`).style.width = ((totalTokens / maxTokens) * 100) + '%';
          document.getElementById(`${m}-cost`).textContent = 'FREE';
        } else {
          document.getElementById(`${m}-bar`).style.width = ((cost / maxCost) * 100) + '%';
          document.getElementById(`${m}-cost`).textContent = '$' + cost.toFixed(4);
        }
      });
    }

    // â”€â”€ Main render â”€â”€
    function updateDashboard(d) {
      dashData = d;

      // Session
      const totalTokens = (d.session?.tokensIn || 0) + (d.session?.tokensOut || 0);
      document.getElementById('session-tokens').textContent = totalTokens.toLocaleString() + ' tokens';
      document.getElementById('model-name').textContent = d.model || 'â€”';

      // Session cost
      if (d.pricing?.opus && d.session) {
        const price = d.pricing.opus;
        const inCost = ((d.session.tokensIn || 0) / 1000000) * price.inputPerMillion;
        const outCost = ((d.session.tokensOut || 0) / 1000000) * price.outputPerMillion;
        document.getElementById('session-cost').textContent = '$' + (inCost + outCost).toFixed(4);
      }

      // Context
      if (d.context) {
        const pct = Math.round((d.context.used / d.context.max) * 100);
        document.getElementById('context-pct').textContent = pct + '%';
        document.getElementById('context-detail').textContent =
          `${(d.context.used/1000).toFixed(0)}k / ${(d.context.max/1000).toFixed(0)}k`;
        document.getElementById('context-bar').style.width = pct + '%';
        const ctxBar = document.getElementById('context-bar');
        ctxBar.className = 'progress-fill' + (pct > 80 ? ' danger' : pct > 60 ? ' warning' : '');
      }

      // Credits
      renderCredits(d);

      // Today
      if (d.today) {
        const todayTokens = (d.today.tokensIn || 0) + (d.today.tokensOut || 0);
        document.getElementById('today-cost').textContent = '$' + (d.today.cost || 0).toFixed(4);
        document.getElementById('today-tokens').textContent = todayTokens.toLocaleString() + ' tokens';
        document.getElementById('today-sessions').textContent = d.today.sessions || 0;
      }

      // Daily Average
      if (d.dailyAverage) {
        document.getElementById('avg-cost').textContent = '$' + (d.dailyAverage.cost || 0).toFixed(4);
        document.getElementById('avg-tokens').textContent = (d.dailyAverage.tokens || 0).toLocaleString() + ' tokens';
        document.getElementById('avg-sessions').textContent = (d.dailyAverage.sessions || 0).toFixed(1);
      }

      // Token breakdown
      if (d.total) {
        document.getElementById('total-input').textContent = (d.total.input || d.total.tokensIn || 0).toLocaleString();
        document.getElementById('total-output').textContent = (d.total.output || d.total.tokensOut || 0).toLocaleString();
        document.getElementById('total-cache-read').textContent = (d.total.cacheRead || 0).toLocaleString();
        document.getElementById('total-cache-write').textContent = (d.total.cacheWrite || 0).toLocaleString();
        const ioCost = (((d.total.input || d.total.tokensIn || 0)) / 1000000) * 15 +
                        (((d.total.output || d.total.tokensOut || 0)) / 1000000) * 75;
        const cacheCost = ((d.total.cacheRead || 0) / 1000000) * 0.5 +
                          ((d.total.cacheWrite || 0) / 1000000) * 6.25;
        document.getElementById('cost-io').textContent = '$' + ioCost.toFixed(4);
        document.getElementById('cost-cache').textContent = '$' + cacheCost.toFixed(4);
      }

      // Model usage
      renderModels(d);

      document.getElementById('updated').textContent = 'Updated: ' + new Date().toLocaleTimeString();
    }

    // â”€â”€ Render: Cron Jobs â”€â”€
    function renderCronJobs(jobs) {
      const container = document.getElementById('cron-list');
      if (!jobs || jobs.length === 0) {
        container.innerHTML = '<div style="color: #666; font-size: 12px;">No scheduled jobs</div>';
        return;
      }

      const modelNames = {
        'ollama/llama3.2:3b': 'local',
        'anthropic/claude-sonnet-4-5': 'sonnet',
        'anthropic/claude-haiku-4-5': 'haiku',
        'anthropic/claude-opus-4-5': 'opus'
      };

      // Estimate tokens and cost per run
      const estimates = {
        'dashboard-sync': { tokens: 2000, model: 'local', cost: 0, frequency: 'hourly' },
        'Evening Routine': { tokens: 8000, model: 'sonnet', cost: 0.144, frequency: 'daily' },
        'Daily Config & Memory Review': { tokens: 6000, model: 'sonnet', cost: 0.108, frequency: 'daily' },
        'Moltbook Weekly Review': { tokens: 15000, model: 'sonnet', cost: 0.27, frequency: 'weekly' },
        'healthcheck:security-audit': { tokens: 5000, model: 'sonnet', cost: 0.09, frequency: 'weekly' }
      };

      let html = '';
      jobs.forEach(job => {
        if (!job.enabled) return; // Skip disabled jobs

        const est = estimates[job.name] || { tokens: 3000, model: 'unknown', cost: 0.054, frequency: 'varies' };
        const modelShort = modelNames[job.payload?.model] || est.model || 'sonnet';
        
        // Parse schedule
        let scheduleText = '';
        if (job.schedule.kind === 'cron') {
          scheduleText = job.schedule.expr + ' (' + (job.schedule.tz || 'UTC') + ')';
        } else if (job.schedule.kind === 'every') {
          const mins = Math.round(job.schedule.everyMs / 60000);
          scheduleText = 'Every ' + (mins >= 60 ? (mins/60) + 'h' : mins + 'm');
        }

        // Calculate monthly cost
        let monthlyCost = 0;
        if (est.frequency === 'hourly') monthlyCost = est.cost * 24 * 30;
        else if (est.frequency === 'daily') monthlyCost = est.cost * 30;
        else if (est.frequency === 'weekly') monthlyCost = est.cost * 4.3;

        html += `
          <div class="cron-item">
            <div class="cron-header">
              <span class="cron-name">${job.name}</span>
              <span class="cron-enabled ${job.enabled ? 'on' : 'off'}">${job.enabled ? 'Active' : 'Disabled'}</span>
            </div>
            <div class="cron-details">
              <div class="cron-detail">
                <span class="cron-detail-label">Model</span>
                <span class="cron-detail-value">
                  <span class="cron-model-badge ${modelShort}">${modelShort}</span>
                </span>
              </div>
              <div class="cron-detail">
                <span class="cron-detail-label">Est. Tokens/Run</span>
                <span class="cron-detail-value">${est.tokens.toLocaleString()}</span>
              </div>
              <div class="cron-detail">
                <span class="cron-detail-label">Est. Cost/Month</span>
                <span class="cron-detail-value">${monthlyCost === 0 ? 'FREE' : '$' + monthlyCost.toFixed(3)}</span>
              </div>
            </div>
            <div class="cron-schedule">ðŸ“… ${scheduleText}</div>
          </div>
        `;
      });

      container.innerHTML = html;
    }

    // â”€â”€ Load & auto-refresh â”€â”€
    function load() {
      fetch('stats.json?v=' + Date.now()).then(r => r.json()).then(updateDashboard).catch(() => {});
    }

    function loadCronJobs() {
      fetch('/api/cron/jobs').then(r => r.json()).then(data => {
        if (data.jobs) renderCronJobs(data.jobs);
      }).catch(() => {});
    }

    load();
    loadCronJobs();
    setInterval(load, 30000);
    setInterval(loadCronJobs, 120000); // Refresh cron list every 2 minutes
  </script>
</body>
</html>
